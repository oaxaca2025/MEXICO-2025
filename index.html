<!DOCTYPE html>
<html lang="it">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
Â  <title>OAXACA 2025 - Planner</title>

Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  <meta name="theme-color" content="#ff0000">
Â Â 
Â  <link rel="manifest" href="/MEXICO-2025/manifest.json">
Â  <link rel="apple-touch-icon" href="/MEXICO-2025/icon-512.png">
Â  <link rel="icon" type="image/png" href="/MEXICO-2025/icon-192.png" sizes="192x192">

Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
Â  <style>
Â  Â  @import url('https://fonts.googleapis.com/css2?family=Special+Elite&display=swap');
Â  Â  @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&display=swap');

Â  Â  :root {
Â  Â  Â  --bg-image: url('https://images.unsplash.com/photo-1518638150340-f706e_86654de?ixlib=rb-1.2.1&auto=format&fit=crop&w=1500&q=80');
Â  Â  }

Â  Â  * {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  -webkit-tap-highlight-color: transparent;
Â  Â  }
Â  Â Â 
Â  Â  body {
Â  Â  Â  color: #333;
Â  Â  Â  line-height: 1.6;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  font-family: 'Oswald', sans-serif;
Â  Â  }

Â  Â  #background-layer {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100vh;
Â  Â  Â  background-image: var(--bg-image);
Â  Â  Â  background-size: cover;
Â  Â  Â  background-position: center;
Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  z-index: -1;
Â  Â  Â  transition: background-image .5s ease;
Â  Â  }

Â  Â  /* Intro */
Â  Â  .intro-page {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  padding: 20px;
Â  Â  Â  text-align: center;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â Â 
Â  Â  .intro-title {
Â  Â  Â  font-family: 'Special Elite', cursive;
Â  Â  Â  color: #ff0000;
Â  Â  Â  font-size: clamp(3rem, 12vw, 8rem);
Â  Â  Â  letter-spacing: 8px;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  line-height: 1;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  text-shadow: 2px 2px 4px rgba(0,0,0,.3);
Â  Â  }
Â  Â Â 
Â  Â  .intro-buttons {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 50px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 20px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 500px;
Â  Â  }
Â  Â Â 
Â  Â  .start-btn, .bg-btn {
Â  Â  Â  background: rgba(0, 0, 0, 0.4);
Â  Â  Â  color: #fff;
Â  Â  Â  border: 1px solid #fff;
Â  Â  Â  padding: 12px 24px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  transition: all .3s;
Â  Â  Â  font-family: 'Oswald', sans-serif;
Â  Â  Â  min-width: 180px;
Â  Â  Â  justify-content: center;
Â  Â  Â  -webkit-touch-callout: none;
Â  Â  Â  -webkit-user-select: none;
Â  Â  Â  user-select: none;
Â  Â  Â  backdrop-filter: blur(4px); /* CORREZIONE: Aggiunto punto e virgola mancante */
Â  Â  }
Â  Â Â 
Â  Â  .start-btn:hover, .bg-btn:hover {
Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  transform: translateY(-2px);
Â  Â  }

Â  Â  /* App */
Â  Â  .container {
Â  Â  Â  max-width: 1200px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding: 20px;
Â  Â  Â  display: none;
Â  Â  Â  overflow: visible;
Â  Â  }
Â  Â Â 
Â  Â  .planner-header {
Â  Â  Â  position: relative;
Â  Â  Â  z-index: 1;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  padding: 15px 20px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  background: transparent;
Â  Â  }
Â  Â Â 
Â  Â  .planner-title {
Â  Â  Â  font-family: 'Special Elite', cursive;
Â  Â  Â  color: #ff0000;
Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  margin: 0;
Â  Â  Â  text-shadow: 1px 1px 2px rgba(0,0,0,.3);
Â  Â  Â  flex: 1;
Â  Â  }
Â  Â Â 
Â  Â  .header-right-section {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: flex-end;
Â  Â  Â  gap: 10px;
Â  Â  Â  min-width: 250px;
Â  Â  }
Â  Â Â 
Â  Â  .header-buttons {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 15px;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: flex-end;
Â  Â  Â  width: 100%;
Â  Â  }
Â  Â Â 
Â  Â  .add-day-btn, .dropdown-btn {
Â  Â  Â  background: rgba(255,255,255,.9);
Â  Â  Â  color: #000;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 6px;
Â  Â  Â  font-weight: 500;
Â  Â  Â  font-size: .9rem;
Â  Â  Â  transition: all .3s;
Â  Â  Â  font-family: 'Oswald', sans-serif;
Â  Â  }
Â  Â Â 
Â  Â  .add-day-btn:hover, .dropdown-btn:hover {
Â  Â  Â  background: rgba(0,0,0,.1);
Â  Â  Â  transform: translateY(-2px);
Â  Â  }

Â  Â  /* Dropdown */
Â  Â  .dropdown {
Â  Â  Â  position: relative;
Â  Â  Â  display: inline-block;
Â  Â  }
Â  Â Â 
Â  Â  .dropdown-content {
Â  Â  Â  display: none;
Â  Â  Â  position: absolute;
Â  Â  Â  right: 0;
Â  Â  Â  background: #fff;
Â  Â  Â  min-width: 200px;
Â  Â  Â  box-shadow: 0 8px 16px rgba(0,0,0,.2);
Â  Â  Â  z-index: 10000;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  }
Â  Â Â 
Â  Â  .dropdown-content a {
Â  Â  Â  color: #000;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  text-decoration: none;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  transition: background-color .3s;
Â  Â  Â  font-size: .9rem;
Â  Â  }
Â  Â Â 
Â  Â  .dropdown-content a:hover {
Â  Â  Â  background: #f1f1f1;
Â  Â  }
Â  Â Â 
Â  Â  .dropdown:hover .dropdown-content {
Â  Â  Â  display: block;
Â  Â  }

Â  Â  .days-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 25px;
Â  Â  }
Â  Â Â 
Â  Â  .day-card {
Â  Â  Â  background: rgba(255,255,255,.9);
Â  Â  Â  border-radius: 15px;
Â  Â  Â  padding: 25px;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  Â  border: 1px solid rgba(255,255,255,.5);
Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,.1);
Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  transition: transform .3s, box-shadow .3s;
Â  Â  }
Â  Â Â 
Â  Â  .day-card:hover {
Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,.15);
Â  Â  }
Â  Â Â 
Â  Â  .day-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 25px;
Â  Â  Â  padding-bottom: 15px;
Â  Â  Â  border-bottom: 2px solid rgba(0,0,0,.1);
Â  Â  }
Â  Â Â 
Â  Â  .day-date-container {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 15px;
Â  Â  }
Â  Â Â 
Â  Â  .day-date {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 10px;
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  transition: all .3s;
Â  Â  Â  border: 1px dashed transparent;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â Â 
Â  Â  .day-date:hover {
Â  Â  Â  background: rgba(0,0,0,.05);
Â  Â  }

Â  Â  .day-date input[data-input] {
Â  Â  Â  Â  font-family: 'Oswald', sans-serif;
Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  color: #000;
Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  width: 110px;Â 
Â  Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .day-date input[data-input]:focus {
Â  Â  Â  Â  outline: none;
Â  Â  }

Â  Â  .day-date .fa-calendar[data-toggle] {
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â Â 
Â  Â  .day-title {
Â  Â  Â  font-size: 1rem;
Â  Â  Â  font-weight: 500;
Â  Â  Â  color: #555;
Â  Â  Â  background: rgba(255,255,255,.7);
Â  Â  Â  padding: 4px 10px;
Â  Â  Â  border-radius: 12px;
Â     border: none;
Â  Â  Â  outline: none;
Â  Â  Â  width: auto;
Â  Â  Â  min-width: 120px;
Â  Â  }
Â  Â Â 
Â  Â  .day-actions {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â Â 
Â  Â  .delete-day, .drag-handle {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: #999;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  background: rgba(255,255,255,.7);
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 35px;
Â  Â  Â  height: 35px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  transition: all .3s;
Â  Â  }
Â  Â Â 
Â  Â  .delete-day:hover {
Â  Â  Â  color: #e74c3c;
Â  Â  Â  background: rgba(255,255,255,.9);
Â  Â  }
Â  Â Â 
Â  Â  .drag-handle {
Â  Â  Â  cursor: grab;
Â  Â  }
Â  Â Â 
Â  Â  .drag-handle:active {
Â  Â  Â  cursor: grabbing;
Â  Â  }

Â  Â  .day-content {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  gap: 20px;
Â  Â  }
Â  Â Â 
Â  Â  .section {
Â  Â  Â  padding: 20px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  Â  box-shadow: 0 3px 10px rgba(0,0,0,.08);
Â  Â  Â  transition: transform .3s;
Â  Â  }
Â  Â Â 
Â  Â  .section:hover {
Â  Â  Â  transform: translateY(-3px);
Â  Â  }
Â  Â Â 
Â  Â  .section.places { background: rgba(173,216,230,.8); }
Â  Â  .section.accommodation { background: rgba(255,182,193,.8); }
Â  Â  .section.transport { background: rgba(144,238,144,.8); }
Â  Â  .section.notes { background: rgba(255,255,153,.8); }
Â  Â Â 
Â  Â  .section-title {
Â  Â  Â  font-family: 'Special Elite', cursive;
Â  Â  Â  font-weight: 600;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  color: #000;
Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  border-bottom: 2px solid rgba(0,0,0,.1);
Â  Â  Â  padding-bottom: 8px;
Â  Â  Â  text-transform: uppercase;
Â  Â  }
Â  Â Â 
Â  Â  .section-content {
Â  Â  Â  padding: 15px;
Â  Â  Â  border: 1px dashed rgba(0,0,0,.15);
Â  Â  Â  border-radius: 10px;
Â  Â  Â  background: rgba(255,255,255,.5);
Â  Â  }
Â  Â Â 
Â  Â  .editable {
Â  Â  Â  min-height: 80px;
Â  Â  Â  padding: 10px;
Â  Â  Â  outline: none;
Â  Â  Â  width: 100%;
Â  Â  Â  border: none;
Â  Â  Â  background: transparent;
Â  Â  Â  resize: vertical;
Â  Â  Â  font-family: 'Oswald', sans-serif;
Â  Â  }

Â  Â  .editable a {
Â  Â  Â  Â  color: #0066cc;
Â  Â  Â  Â  text-decoration: underline;
Â  Â  }

Â  Â  .file-attachments {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â Â 
Â  Â  .attachment-item {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 5px;
Â  Â  Â  padding: 8px;
Â  Â  Â  background: rgba(255,255,255,.8);
Â  Â  Â  border-radius: 6px;
Â  Â  Â  border: 1px solid rgba(255,255,255,.5);
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all .2s;
Â  Â  Â  width: 100px;
Â  Â  Â  text-align: center;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â Â 
Â  Â  .attachment-item:hover {
Â  Â  Â  background: #fff;
Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â Â 
Â  Â  .attachment-thumbnail {
Â  Â  Â  width: 60px;
Â  Â  Â  height: 60px;
Â  Â  Â  object-fit: cover;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  background: #f0f0f0;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 30px;Â 
Â  Â  Â  color: #7F8C8D;
Â  Â  }
Â  Â Â 
Â  Â  .attachment-thumbnail .fa-file-pdf {
Â  Â  Â  color: #e74c3c;Â 
Â  Â  Â  font-size: 36px;
Â  Â  }

Â  Â  .attachment-thumbnail img {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  object-fit: cover;
Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â Â 
Â  Â  .attachment-name {
Â  Â  Â  font-size: .7rem;
Â  Â  Â  color: #000;
Â  Â  Â  word-break: break-all;
Â  Â  Â  width: 100%;
Â  Â  }
Â  Â Â 
Â  Â  .delete-attachment-btn {
Â  Â  Â  position: absolute;
Â  Â  Â  top: -5px;
Â  Â  Â  right: -5px;
Â  Â  Â  background: #ff0000;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: none;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â Â 
Â  Â  .attachment-item:hover .delete-attachment-btn {
Â  Â  Â  display: flex;
Â  Â  }
Â  Â Â 
Â  Â  .add-attachment-btn {
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: #7F8C8D;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 5px;
Â  Â  Â  font-size: .9rem;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  transition: all .2s;
Â  Â  Â  padding: 5px;
Â  Â  }
Â  Â Â 
Â  Â  .add-attachment-btn:hover {
Â  Â  Â  color: #2980B9;
Â  Â  }

Â  Â  /* Storage Status */
Â  Â  .storage-status {
Â  Â  Â  background: rgba(255,255,255,0.9);
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  border-left: 4px solid #28a745;
Â  Â  }

Â  Â  .storage-status.warning {
Â  Â  Â  border-left-color: #ffc107;
Â  Â  Â  background: rgba(255,193,7,0.1);
Â  Â  }

Â  Â  .storage-status.danger {
Â  Â  Â  border-left-color: #dc3545;
Â  Â  Â  background: rgba(220,53,69,0.1);
Â  Â  }

Â  Â  /* Modals */
Â  Â  .modal {
Â  Â  Â  display: none;
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: rgba(0,0,0,.7);
Â  Â  Â  z-index: 5000;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â Â 
Â  Â  .modal-content {
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 30px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 500px;
Â  Â  Â  box-shadow: 0 5px 25px rgba(0,0,0,.3);
Â  Â  Â  max-height: 90vh;
Â  Â  Â  overflow-y: auto;
Â  Â  }
Â  Â Â 
Â  Â  .modal-title {
Â  Â  Â  font-family: 'Special Elite', cursive;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  text-align: center;
Â  Â  Â  font-size: 1.5rem;
Â  Â  }

Â  Â  .bg-options {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  gap: 15px;
Â  Â  Â  margin-bottom: 25px;
Â  Â  }
Â  Â Â 
Â  Â  .bg-option {
Â  Â  Â  height: 100px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  background-size: cover;
Â  Â  Â  background-position: center;
Â  Â  Â  border: 3px solid transparent;
Â  Â  Â  transition: all .3s;
Â  Â  }
Â  Â Â 
Â  Â  .bg-option:hover {
Â  Â  Â  transform: scale(1.05);
Â  Â  }
Â  Â Â 
Â  Â  .bg-option.selected {
Â  Â  Â  border-color: #000;
Â  Â  }

Â  Â  .file-input-container {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â Â 
Â  Â  .file-input-label {
Â  Â  Â  display: block;
Â  Â  Â  padding: 10px;
Â  Â  Â  background: #f0f0f0;
Â  Â  Â  border: 1px dashed #ccc;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  text-align: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all .3s;
Â  Â  }
Â  Â Â 
Â  Â  .file-input-label:hover {
Â  Â  Â  background: #e0e0e0;
Â  Â  }
Â  Â Â 
Â  Â  .file-input {
Â  Â  Â  position: absolute;
Â  Â  Â  left: -9999px;
Â  Â  }
Â  Â Â 
Â  Â  .custom-bg-input {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  margin-top: 15px;
Â  Â  }
Â  Â Â 
Â  Â  .modal-buttons {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: flex-end;
Â  Â  Â  gap: 15px;
Â  Â  Â  margin-top: 20px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â Â 
Â  Â  .modal-btn {
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-family: 'Oswald', sans-serif;
Â  Â  Â  font-weight: 500;
Â  Â  Â  border: 1px solid #000;
Â  Â  Â  background: transparent;
Â  Â  Â  transition: all .3s;
Â  Â  Â  min-width: 100px;
Â  Â  }
Â  Â Â 
Â  Â  .modal-btn.primary {
Â  Â  Â  background: #000;
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â Â 
Â  Â  .modal-btn:hover {
Â  Â  Â  background: rgba(0,0,0,.1);
Â  Â  }
Â  Â Â 
Â  Â  .modal-btn.primary:hover {
Â  Â  Â  background: #333;
Â  Â  }

Â  Â  footer {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-top: 40px;
Â  Â  Â  padding: 20px;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: .9rem;
Â  Â  Â  text-shadow: 1px 1px 2px #000;
Â  Â  }

Â  Â  /* Notification */
Â  Â  .notification {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 20px;
Â  Â  Â  right: 20px;
Â  Â  Â  padding: 15px 20px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  background: #333;
Â  Â  Â  color: #fff;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,.2);
Â  Â  Â  transform: translateY(100px);
Â  Â  Â  opacity: 0;
Â  Â  Â  transition: transform .3s, opacity .3s;
Â  Â  Â  z-index: 6000;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â Â 
Â  Â  .notification.show {
Â  Â  Â  transform: translateY(0);
Â  Â  Â  opacity: 1;
Â  Â  }

Â  Â  .fullscreen-attachment {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background-color: rgba(0, 0, 0, 0.9);
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 10000;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 20px;Â 
Â  Â  }
Â  Â Â 
Â  Â  .fullscreen-attachment img {
Â  Â  Â  max-width: 95%;Â Â 
Â  Â  Â  max-height: 95%;
Â  Â  Â  object-fit: contain;
Â  Â  }
Â  Â Â 
Â  Â  .close-fullscreen {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 20px;
Â  Â  Â  right: 20px;
Â  Â  Â  color: white;
Â  Â  Â  background: rgba(0, 0, 0, 0.5);
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  width: 40px;
Â  Â  Â  height: 40px;
Â  Â  Â  font-size: 20px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  z-index: 10001;
Â  Â  }

Â  Â  /* Print */
Â  Â  @media print {
Â  Â  Â  * {
Â  Â  Â  Â  color: #000 !important;
Â  Â  Â  Â  background-color: #fff !important;
Â  Â  Â  Â  box-shadow: none !important;
Â  Â  Â  Â  text-shadow: none !important;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  #background-layer, .intro-page, .planner-header .header-right-section, .day-actions, .add-attachment-btn, footer, .notification, .modal, #storage-status {
Â  Â  Â  Â  display: none !important;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  body {
Â  Â  Â  Â  font-family: 'Times New Roman', serif;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .container {
Â  Â  Â  Â  display: block !important;
Â  Â  Â  Â  max-width: 100% !important;
Â  Â  Â  Â  padding: 0 !important;
Â  Â  Â  Â  margin: 0 !important;
Â  Â  Â  }

Â  Â  Â  .day-card {
Â  Â  Â  Â  border: 1px solid #ccc !important;
Â  Â  Â  Â  padding: 15px !important;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  break-inside: avoid;
Â  Â  Â  }

Â  Â  Â  .day-content {
Â  Â  Â  Â  display: block !important;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .section {
Â  Â  Â  Â  Â border: 1px solid #eee !important;
Â  Â  Â  Â  Â padding: 10px;
Â  Â  Â  Â  Â margin-bottom: 10px;
Â  Â  Â  Â  Â break-inside: avoid;
Â  Â  Â  }

Â  Â  Â  .editable a {
Â  Â  Â  Â  text-decoration: underline !important;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .file-attachments {
Â  Â  Â  Â  display: none !important;
Â  Â  Â  }
Â  Â  }

Â  Â  /* iPhone e dispositivi mobili */
Â  Â  @media (max-width: 768px) {
Â  Â  Â  .intro-buttons {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .day-content {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .planner-header {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .planner-title {
Â  Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .header-right-section {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .header-buttons {
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .add-day-btn, .dropdown-btn {
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  min-height: 44px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .day-card {
Â  Â  Â  Â  padding: 20px 15px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .day-header {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .day-date-container {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  }

Â  Â  Â  .day-date input.flatpickr-input {
Â  Â  Â  Â  font-family: 'Oswald', sans-serif !important;
Â  Â  Â  Â  font-size: 1.4rem !important;
Â  Â  Â  Â  font-weight: 700 !important;
Â  Â  Â  Â  color: #000000 !important;
Â  Â  Â  Â  -webkit-text-fill-color: #000000 !important;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .day-actions {
Â  Â  Â  Â  align-self: flex-end;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .section {
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .section-title {
Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .section-content {
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .modal-content {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  margin: 20px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .bg-options {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .modal-buttons {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .modal-btn {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dropdown-content {
Â  Â  Â  Â  right: auto;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  min-width: 200px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .file-attachments {
Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .attachment-item {
Â  Â  Â  Â  width: 85px;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .attachment-thumbnail {
Â  Â  Â  Â  width: 50px;
Â  Â  Â  Â  height: 50px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .attachment-name {
Â  Â  Â  Â  font-size: .7rem;
Â  Â  Â  Â  color: #000;
Â  Â  Â  Â  word-break: break-all;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .delete-attachment-btn {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: -5px;
Â  Â  Â  Â  right: -5px;
Â  Â  Â  Â  background: #ff0000;
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .attachment-item:hover .delete-attachment-btn {
Â  Â  Â  Â  display: flex;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .add-attachment-btn {
Â  Â  Â  Â  background: none;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  color: #7F8C8D;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  font-size: .9rem;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  transition: all .2s;
Â  Â  Â  Â  padding: 5px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .add-attachment-btn:hover {
Â  Â  Â  Â  color: #2980B9;
Â  Â  Â  }

Â  Â  Â  footer {
Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  input, select, textarea {
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .editable:focus {
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  }

Â  Â  /* Supporto per notch e aree sicure iPhone */
Â  Â  @supports(padding: max(0px)) {
Â  Â  Â  .intro-page, .container, .modal {
Â  Â  Â  Â  padding-left: max(20px, env(safe-area-inset-left));
Â  Â  Â  Â  padding-right: max(20px, env(safe-area-inset-right));
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .intro-buttons {
Â  Â  Â  Â  padding-bottom: max(20px, env(safe-area-inset-bottom));
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  body {
Â  Â  Â  Â  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .planner-header, .day-card {
Â  Â  Â  Â  padding-left: max(20px, env(safe-area-inset-left));
Â  Â  Â  Â  padding-right: max(20px, env(safe-area-inset-right));
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="background-layer"></div>
Â  Â  <div class="intro-page" id="introPage">
Â  Â  <h1 class="intro-title">OAXACA 2025</h1>
Â  Â  <div class="intro-buttons">
Â  Â  Â  <button class="start-btn" id="startBtn"><i class="fas fa-pencil-alt"></i> Inizia a pianificare</button>
Â  Â  Â  <button class="bg-btn" id="bgBtn"><i class="fas fa-image"></i> Sfondo</button>
Â  Â  </div>
Â  </div>

Â  Â  <div class="container" id="plannerContainer">
Â  Â  <div class="planner-header">
Â  Â  Â  <h1 class="planner-title" id="dynamicTitle">OAXACA 2025</h1>
Â  Â  Â  <div class="header-right-section">
Â  Â  Â  Â  <div class="header-buttons">
Â  Â  Â  Â  Â  <button class="add-day-btn" id="addDayBtn"><i class="fas fa-plus"></i> Aggiungi Giorno</button>
Â  Â  Â  Â  Â  <div class="dropdown">
Â  Â  Â  Â  Â  Â  <button class="dropdown-btn" aria-haspopup="true" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
Â  Â  Â  Â  Â  Â  <div class="dropdown-content" role="menu">
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="saveBtn"><i class="fas fa-save"></i> Salva Backup Manuale</a>
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="autoSaveBtn"><i class="fas fa-sync"></i> Salva Backup Automatico</a>
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="importBtn"><i class="fas fa-upload"></i> Importa Backup</a>
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="printBtn"><i class="fas fa-print"></i> Stampa</a>
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="resetBtn"><i class="fas fa-trash"></i> Reset Planner</a>
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="backgroundBtn"><i class="fas fa-image"></i> Sfondo</a>
Â  Â  Â  Â  Â  Â  Â  <a href="#" id="homeBtn"><i class="fas fa-home"></i> Home</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="storage-status" id="storageStatus">
Â  Â  Â  Â  Â  <i class="fas fa-check-circle"></i>
Â  Â  Â  Â  Â  <span id="storageStatusText">Tutto salvato</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="days-container" id="daysContainer"></div>

Â  Â  <footer><p>OAXACA 2025 &copy; - Salvataggio automatico su file JSON attivo</p></footer>
Â  </div>

Â  Â  <div class="modal" id="backgroundModal">
Â  Â  <div class="modal-content">
Â  Â  Â  <h2 class="modal-title">Seleziona Sfondo</h2>
Â  Â  Â  <div class="bg-options" id="bgOptions">
Â  Â  Â  Â  <div class="bg-option" style="background-image:url('https://images.unsplash.com/photo-1518638150340-f706e_86654de?auto=format&fit=crop&w=500&q=80');" data-bg="https://images.unsplash.com/photo-1518638150340-f706e_86654de?auto=format&fit=crop&w=1500&q=80"></div>
Â  Â  Â  Â  <div class="bg-option" style="background-image:url('https://images.unsplash.com/photo-1520942702014-8f2a5e7b74c3?auto=format&fit=crop&w=500&q=80');" data-bg="https://images.unsplash.com/photo-1520942702014-8f2a5e7b74c3?auto=format&fit=crop&w=1500&q=80"></div>
Â  Â  Â  Â  <div class="bg-option" style="background-image:url('https://images.unsplash.com/photo-1542272454315-4db10c9c42a5?auto=format&fit=crop&w=500&q=80');" data-bg="https://images.unsplash.com/photo-1542272454315-4db10c9c42a5?auto=format&fit=crop&w=1500&q=80"></div>
Â  Â  Â  Â  <div class="bg-option" style="background-image:url('https://images.unsplash.com/photo-1623051162674-4d16f16f50d8?auto=format&fit=crop&w=500&q=80');" data-bg="https://images.unsplash.com/photo-1623051162674-4d16f16f50d8?auto=format&fit=crop&w=1500&q=80"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="file-input-container">
Â  Â  Â  Â  <label for="bgFileInput" class="file-input-label"><i class="fas fa-upload"></i> Carica immagine</label>
Â  Â  Â  Â  <input type="file" id="bgFileInput" class="file-input" accept="image/*" />
Â  Â  Â  </div>
Â  Â  Â  <input type="text" class="custom-bg-input" id="customBgInput" placeholder="Incolla URL immagine" />
Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  <button class="modal-btn" id="cancelBgBtn">Annulla</button>
Â  Â  Â  Â  <button class="modal-btn primary" id="applyBgBtn">Applica</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="modal" id="attachmentModal">
Â  Â  <div class="modal-content">
Â  Â  Â  <h2 class="modal-title">Aggiungi Allegato</h2>
Â  Â  Â  <div class="file-input-container">
Â  Â  Â  Â  <label for="attachmentFileInput" class="file-input-label"><i class="fas fa-upload"></i> Carica file (Immagine/PDF)</label>
Â  Â  Â  Â  <input type="file" id="attachmentFileInput" class="file-input" accept="image/*,.pdf" />
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  <button class="modal-btn" id="cancelAttachBtn">Annulla</button>
Â  Â  Â  Â  <button class="modal-btn primary" id="confirmAttachBtn">Aggiungi</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="modal" id="confirmModal">
Â  Â  <div class="modal-content">
Â  Â  Â  <h2 class="modal-title" id="confirmModalTitle"></h2>
Â  Â  Â  <p id="confirmModalText" style="text-align: center; margin-bottom: 20px;"></p>
Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  <button class="modal-btn" id="cancelConfirmBtn">Annulla</button>
Â  Â  Â  Â  <button class="modal-btn primary" id="confirmBtn">Conferma</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="notification" id="notification">
Â  Â  <i id="notificationIcon" class="fas fa-check-circle"></i>
Â  Â  <span id="notificationText"></span>
Â  </div>

Â  <input type="file" id="importFileInput" style="display: none;" accept=".json" />

Â  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
Â  <script>
Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  class AdvancedPlanner {
Â  Â  Â  Â  constructor() {
Â  Â  Â  Â  Â  this.tripData = {Â 
Â  Â  Â  Â  Â  Â  days: [],Â 
Â  Â  Â  Â  Â  Â  background: 'https://images.unsplash.com/photo-1518638150340-f706e_86654de?ixlib=rb-1.2.1&auto=format&fit=crop&w=1500&q=80',
Â  Â  Â  Â  Â  Â  lastAutoSave: null,
Â  Â  Â  Â  Â  Â  version: '2.0'
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  this.currentAttachmentContext = {};
Â  Â  Â  Â  Â  this.onConfirmCallback = null;
Â  Â  Â  Â  Â  this.unsavedChanges = false;
Â  Â  Â  Â  Â  this.autoSaveTimeout = null;
Â  Â  Â  Â  Â  this.autoSaveInterval = null;
Â  Â  Â  Â  Â  this.isStandaloneApp = this.detectStandaloneApp();
Â  Â  Â  Â  Â  this.isSafari = this.detectSafari();
Â  Â  Â  Â  Â  this.isMobile = this.detectMobile();
Â  Â  Â  Â  Â  this.isPrivateMode = false;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  this.init();
Â  Â  Â  Â  }

Â  Â  Â  Â  detectStandaloneApp() {
Â  Â  Â  Â  Â  return window.navigator.standalone ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â window.matchMedia('(display-mode: standalone)').matches ||
Â  Â  Â  Â  Â  Â  Â  Â  Â document.referrer.includes('android-app://');
Â  Â  Â  Â  }

Â  Â  Â  Â  detectSafari() {
Â  Â  Â  Â  Â  // Rileva Safari escludendo Chrome/Edge su iOS
Â  Â  Â  Â  Â  return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
Â  Â  Â  Â  }

Â  Â  Â  Â  detectMobile() {
Â  Â  Â  Â  Â  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
Â  Â  Â  Â  }

Â  Â  Â  Â  async checkPrivateMode() {
Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('private_mode_test', 'test');
Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('private_mode_test');
Â  Â  Â  Â  Â  Â  Â  this.isPrivateMode = false;
Â  Â  Â  Â  Â  Â  Â  resolve(false);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  this.isPrivateMode = true;
Â  Â  Â  Â  Â  Â  Â  resolve(true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async init() {
Â  Â  Â  Â  Â  await this.checkPrivateMode();
Â  Â  Â  Â  Â  this.loadFromLocalStorage();
Â  Â  Â  Â  Â  this.setupEventListeners();
Â  Â  Â  Â  Â  this.startAutoSaveSystem();
Â  Â  Â  Â  Â  this.showAppWarningIfNeeded();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (this.isPrivateMode) {
Â  Â  Â  Â  Â  Â  this.showNotification('âš ï¸ ModalitÃ  privata rilevata. I dati non verranno salvati.', 'warning');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  showAppWarningIfNeeded() {
Â  Â  Â  Â  Â  if (this.isStandaloneApp) {
Â  Â  Â  Â  Â  Â  this.showNotification('âš ï¸ ATTENZIONE: Stai usando la versione app. Salva spesso i backup manualmente!', 'error', 8000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  setupEventListeners() {
Â  Â  Â  Â  Â  document.getElementById('startBtn').addEventListener('click', () => this.showPlanner());
Â  Â  Â  Â  Â  document.getElementById('bgBtn').addEventListener('click', () => this.openBackgroundModal());
Â  Â  Â  Â  Â  document.getElementById('backgroundBtn').addEventListener('click', () => this.openBackgroundModal());
Â  Â  Â  Â  Â  document.getElementById('homeBtn').addEventListener('click', () => this.showIntro());
Â  Â  Â  Â  Â  document.getElementById('addDayBtn').addEventListener('click', () => this.addNewDay());
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Pulsanti salvataggio
Â  Â  Â  Â  Â  document.getElementById('saveBtn').addEventListener('click', () => this.manualSaveToJSON());
Â  Â  Â  Â  Â  document.getElementById('autoSaveBtn').addEventListener('click', () => this.forceAutoSave());
Â  Â  Â  Â  Â  document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
Â  Â  Â  Â  Â  document.getElementById('importFileInput').addEventListener('change', (e) => this.handleImport(e));
Â  Â  Â  Â  Â  document.getElementById('printBtn').addEventListener('click', () => window.print());
Â  Â  Â  Â  Â  document.getElementById('resetBtn').addEventListener('click', () => this.resetPlanner());

Â  Â  Â  Â  Â  // Modal Buttons
Â  Â  Â  Â  Â  document.querySelectorAll('.modal .modal-btn[id^="cancel"]').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => btn.closest('.modal').style.display = 'none');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  document.getElementById('applyBgBtn').addEventListener('click', () => this.applyBackground());
Â  Â  Â  Â  Â  document.getElementById('confirmAttachBtn').addEventListener('click', () => this.handleAttachmentConfirm());

Â  Â  Â  Â  Â  // Background Modal
Â  Â  Â  Â  Â  document.getElementById('bgOptions').addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const target = e.target.closest('.bg-option');
Â  Â  Â  Â  Â  Â  if(!target) return;
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  target.classList.add('selected');
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // Confirmation Modal
Â  Â  Â  Â  Â  document.getElementById('confirmBtn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  if(typeof this.onConfirmCallback === 'function') this.onConfirmCallback();
Â  Â  Â  Â  Â  Â  Â  this.closeModal('confirmModal');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  document.getElementById('cancelConfirmBtn').addEventListener('click', () => this.closeModal('confirmModal'));

Â  Â  Â  Â  Â  // Event Delegation for dynamic content
Â  Â  Â  Â  Â  const daysContainer = document.getElementById('daysContainer');
Â  Â  Â  Â  Â  daysContainer.addEventListener('blur', (e) => {
Â  Â  Â  Â  Â  Â  Â  if (e.target.classList.contains('editable')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.autolinkUrls(e.target);
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.handleDataChange(e);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, true);
Â  Â  Â  Â  Â  daysContainer.addEventListener('input', (e) => this.handleDataChange(e));
Â  Â  Â  Â  Â  daysContainer.addEventListener('click', (e) => this.handleDayActions(e));
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  window.addEventListener('beforeunload', (e) => {
Â  Â  Â  Â  Â  Â  Â  if (this.unsavedChanges) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  e.returnValue = 'Hai delle modifiche non salvate. Sei sicuro di voler lasciare la pagina? I dati potrebbero andare persi.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  return 'Hai delle modifiche non salvate. Sei sicuro di voler lasciare la pagina? I dati potrebbero andare persi.';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * âœ… SALVATAGGIO MANUALE
Â  Â  Â  Â  Â * Questa funzione crea un link invisibile e lo clicca per avviare il download.
Â  Â  Â  Â  Â * Ãˆ il metodo piÃ¹ affidabile per tutti i browser, incluso Safari.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  manualSaveToJSON() {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const dataToSave = {
Â  Â  Â  Â  Â  Â  Â  ...this.tripData,
Â  Â  Â  Â  Â  Â  Â  lastManualSave: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  saveType: 'manual'
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const jsonString = JSON.stringify(dataToSave, null, 2);
Â  Â  Â  Â  Â  Â  const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
Â  Â  Â  Â  Â  Â  const filename = `Oaxaca_Planner_${timestamp}.json`;

Â  Â  Â  Â  Â  Â  this.downloadBlob(blob, filename);

Â  Â  Â  Â  Â  Â  this.unsavedChanges = false;
Â  Â  Â  Â  Â  Â  this.updateStorageStatus('success', 'Backup manuale salvato!');
Â  Â  Â  Â  Â  Â  this.showNotification('âœ… Backup salvato con successo!', 'success');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Errore salvataggio manuale:', error);
Â  Â  Â  Â  Â  Â  this.updateStorageStatus('danger', 'Errore nel salvataggio');
Â  Â  Â  Â  Â  Â  this.showNotification('âŒ Errore nel salvataggio del backup', 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * âš™ï¸ FUNZIONE DI UTILITY PER IL DOWNLOAD
Â  Â  Â  Â  Â * Logica di download centralizzata per essere riutilizzata.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  downloadBlob(blob, filename) {
Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  a.download = filename;
Â  Â  Â  Â  Â  a.style.display = 'none';
Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Pulizia per evitare memory leak
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  if (document.body.contains(a)) {
Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * ðŸ”„ SALVATAGGIO AUTOMATICO
Â  Â  Â  Â  Â * MODIFICA: Rileva Safari e, in quel caso, salva solo su localStorage mostrando
Â  Â  Â  Â  Â * una notifica. Altrimenti, procede con il download del file.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  autoSaveToJSON() {
Â  Â  Â  Â  Â  Â  if (!this.unsavedChanges) return;

Â  Â  Â  Â  Â  Â  if (this.isPrivateMode) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Salvataggio automatico disabilitato in modalitÃ  privata.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // NOTA: Se il browser Ã¨ Safari, salva solo localmente senza scaricare file.
Â  Â  Â  Â  Â  Â  Â  Â  if (this.isSafari) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.saveToLocalStorage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.unsavedChanges = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.tripData.lastAutoSave = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateStorageStatus('success', `Salvato in cache alle ${new Date().toLocaleTimeString()}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('â„¹ï¸ Su Safari i dati sono salvati nella cache. Salva manualmente per un backup!', 'info', 6000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Per altri browser, procede al download del file.
Â  Â  Â  Â  Â  Â  Â  Â  const dataToSave = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...this.tripData,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastAutoSave: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveType: 'auto'
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const jsonString = JSON.stringify(dataToSave, null, 2);
Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
Â  Â  Â  Â  Â  Â  Â  Â  const filename = `Oaxaca_AutoBackup_${timestamp}.json`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  this.downloadBlob(blob, filename);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  this.unsavedChanges = false;
Â  Â  Â  Â  Â  Â  Â  Â  this.tripData.lastAutoSave = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  this.updateStorageStatus('success', 'Salvataggio automatico completato');
Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('âœ… Backup automatico salvato!', 'success');

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Errore salvataggio automatico:', error);
Â  Â  Â  Â  Â  Â  Â  Â  this.updateStorageStatus('danger', 'Errore salvataggio automatico');
Â  Â  Â  Â  Â  Â  Â  Â  this.saveToLocalStorage(); // Tenta almeno di salvare su localStorage in caso di errore
Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('âš ï¸ Errore download, dati salvati in cache.', 'warning');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  saveToLocalStorage(forceNotification = false) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (this.isPrivateMode) {
Â  Â  Â  Â  Â  Â  Â  return false; // Non salvare in modalitÃ  privata
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  localStorage.setItem('oaxacaPlannerData', JSON.stringify(this.tripData));
Â  Â  Â  Â  Â  Â  if(forceNotification) {
Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Modifiche salvate nella cache del browser!', 'success');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error('Errore salvataggio localStorage:', e);
Â  Â  Â  Â  Â  Â  this.showNotification('Cache del browser piena! Usa "Salva Backup" per salvare su file.', 'error');
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  loadFromLocalStorage() {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const saved = localStorage.getItem('oaxacaPlannerData');
Â  Â  Â  Â  Â  Â  if(saved) {
Â  Â  Â  Â  Â  Â  Â  const parsedData = JSON.parse(saved);
Â  Â  Â  Â  Â  Â  Â  if(parsedData && Array.isArray(parsedData.days)) {
Â  Â  Â  Â  Â  Â  Â  Â  this.tripData = { ...this.tripData, ...parsedData };
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  this.updateUI();
Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error('Errore caricamento dati:', e);
Â  Â  Â  Â  Â  Â  this.showNotification('Errore nel caricamento dei dati salvati', 'error');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Il resto dei metodi rimane invariato ---

Â  Â  Â  Â  openBackgroundModal() {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  document.getElementById('customBgInput').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('bgFileInput').value = '';
Â  Â  Â  Â  Â  Â  this.openModal('backgroundModal');
Â  Â  Â  Â  }

Â  Â  Â  Â  applyBackground() {
Â  Â  Â  Â  Â  Â  const selectedOption = document.querySelector('.bg-option.selected');
Â  Â  Â  Â  Â  Â  const customUrl = document.getElementById('customBgInput').value.trim();
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('bgFileInput');

Â  Â  Â  Â  Â  Â  if (customUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  this.updateBg(customUrl);
Â  Â  Â  Â  Â  Â  } else if (selectedOption) {
Â  Â  Â  Â  Â  Â  Â  Â  this.updateBg(selectedOption.dataset.bg);
Â  Â  Â  Â  Â  Â  } else if (fileInput.files && fileInput.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateBg(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('âŒ Errore nel caricamento del file', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(fileInput.files[0]);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('âŒ Seleziona uno sfondo o inserisci un URL', 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  updateBg(newBg) {
Â  Â  Â  Â  Â  Â  this.tripData.background = newBg;
Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--bg-image', `url('${newBg}')`);
Â  Â  Â  Â  Â  Â  this.handleDataChange();
Â  Â  Â  Â  Â  Â  this.closeModal('backgroundModal');
Â  Â  Â  Â  Â  Â  this.showNotification('âœ… Sfondo cambiato con successo!', 'success');
Â  Â  Â  Â  }

Â  Â  Â  Â  addNewDay() {
Â  Â  Â  Â  Â  Â  let nextDate = new Date();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (this.tripData.days.length > 0) {
Â  Â  Â  Â  Â  Â  Â  const lastDay = this.tripData.days[this.tripData.days.length - 1];
Â  Â  Â  Â  Â  Â  Â  if (lastDay.date) {
Â  Â  Â  Â  Â  Â  Â  Â  nextDate = this.parseDate(lastDay.date) || new Date();
Â  Â  Â  Â  Â  Â  Â  Â  nextDate.setDate(nextDate.getDate() + 1);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const newDay = {Â 
Â  Â  Â  Â  Â  Â  Â  id: `day_${Date.now()}`,Â 
Â  Â  Â  Â  Â  Â  Â  date: this.formatDate(nextDate),Â 
Â  Â  Â  Â  Â  Â  Â  title: `Giorno ${this.tripData.days.length + 1}`,
Â  Â  Â  Â  Â  Â  Â  places: { text: '', attachments: [] },
Â  Â  Â  Â  Â  Â  Â  accommodation: { text: '', attachments: [] },
Â  Â  Â  Â  Â  Â  Â  transport: { text: '', attachments: [] },
Â  Â  Â  Â  Â  Â  Â  notes: { text: '', attachments: [] }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  this.tripData.days.push(newDay);Â 
Â  Â  Â  Â  Â  Â  this.handleDataChange();
Â  Â  Â  Â  Â  Â  this.renderAllDays();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  forceAutoSave() {
Â  Â  Â  Â  Â  Â  this.showNotification('ðŸ”„ Salvataggio forzato in corso...', 'info');
Â  Â  Â  Â  Â  Â  this.autoSaveToJSON();
Â  Â  Â  Â  }

Â  Â  Â  Â  updateStorageStatus(type, message) {
Â  Â  Â  Â  Â  Â  const statusElement = document.getElementById('storageStatus');
Â  Â  Â  Â  Â  Â  const textElement = document.getElementById('storageStatusText');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  statusElement.className = 'storage-status';
Â  Â  Â  Â  Â  Â  if (type === 'warning') statusElement.classList.add('warning');
Â  Â  Â  Â  Â  Â  if (type === 'danger') statusElement.classList.add('danger');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  textElement.textContent = message;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const icon = statusElement.querySelector('i');
Â  Â  Â  Â  Â  Â  icon.className = type === 'success' ? 'fas fa-check-circle' :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â type === 'warning' ? 'fas fa-exclamation-triangle' :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 'fas fa-exclamation-circle';
Â  Â  Â  Â  }

Â  Â  Â  Â  handleDataChange(e) {
Â  Â  Â  Â  Â  Â  if (e) {
Â  Â  Â  Â  Â  Â  Â  Â  const target = e.target;
Â  Â  Â  Â  Â  Â  Â  Â  const card = target.closest('.day-card');
Â  Â  Â  Â  Â  Â  Â  Â  if (card) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const day = this.tripData.days.find(d => d.id === card.dataset.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (day) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (target.classList.contains('editable')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const type = target.closest('.section').classList[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day[type].text = target.innerHTML;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (target.classList.contains('day-title')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day.title = target.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  this.unsavedChanges = true;
Â  Â  Â  Â  Â  Â  this.updateStorageStatus('warning', 'Modifiche non salvate');
Â  Â  Â  Â  Â  Â  this.saveToLocalStorage();
Â  Â  Â  Â  }

Â  Â  Â  Â  showPlanner(){Â 
Â  Â  Â  Â  Â  document.getElementById('introPage').style.display = 'none';Â 
Â  Â  Â  Â  Â  document.getElementById('plannerContainer').style.display = 'block';Â 
Â  Â  Â  Â  Â  this.updateUI();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showIntro(){Â 
Â  Â  Â  Â  Â  document.getElementById('plannerContainer').style.display = 'none';Â 
Â  Â  Â  Â  Â  document.getElementById('introPage').style.display = 'flex';Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  updateUI() {
Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--bg-image', `url('${this.tripData.background}')`);
Â  Â  Â  Â  Â  this.renderAllDays();
Â  Â  Â  Â  Â  if (this.tripData.days && this.tripData.days.length > 0) {
Â  Â  Â  Â  Â  Â  this.showPlanner();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  renderAllDays(){
Â  Â  Â  Â  Â  const daysContainer = document.getElementById('daysContainer');
Â  Â  Â  Â  Â  daysContainer.innerHTML = '';
Â  Â  Â  Â  Â  this.tripData.days.forEach((d, index) => daysContainer.appendChild(this.createDayCard(d, index)));
Â  Â  Â  Â  }

Â  Â  Â  Â  createDayCard(day, index){
Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  card.className = 'day-card';
Â  Â  Â  Â  Â  card.dataset.id = day.id;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  let displayTitle = day.title || `Giorno ${index + 1}`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="day-header">
Â  Â  Â  Â  Â  Â  Â  <div class="day-date-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="day-date">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-regular fa-calendar" data-toggle></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Seleziona data..." data-input readonly="readonly" />
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="day-title" value="${displayTitle}" placeholder="Titolo giorno" />
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="day-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-day" title="Elimina"><i class="fas fa-trash"></i></button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="day-content">
Â  Â  Â  Â  Â  Â  Â  ${this.createSection('places','Luoghi', day)}
Â  Â  Â  Â  Â  Â  Â  ${this.createSection('accommodation','Alloggio', day)}
Â  Â  Â  Â  Â  Â  Â  ${this.createSection('transport','Trasporti', day)}
Â  Â  Â  Â  Â  Â  Â  ${this.createSection('notes','Note', day)}
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  flatpickr(card.querySelector('.day-date'), {
Â  Â  Â  Â  Â  Â  Â  wrap: true,
Â  Â  Â  Â  Â  Â  Â  locale: 'it',
Â  Â  Â  Â  Â  Â  Â  dateFormat: 'd/m/Y',
Â  Â  Â  Â  Â  Â  Â  defaultDate: this.parseDate(day.date),
Â  Â  Â  Â  Â  Â  Â  onChange: (selectedDates, dateStr) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  day.date = dateStr;
Â  Â  Â  Â  Â  Â  Â  Â  this.handleDataChange();Â 
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  return card;
Â  Â  Â  Â  }

Â  Â  Â  Â  createSection(type, title, day){
Â  Â  Â  Â  Â  const sectionData = day[type] || { text: '', attachments: [] };
Â  Â  Â  Â  Â  const attachmentsHTML = (sectionData.attachments || []).map((att, i) => this.createAttachmentHTML(att, i)).join('');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const icons = { places: 'map-marker-alt', accommodation: 'hotel', transport: 'bus', notes: 'sticky-note' };
Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="section ${type}">
Â  Â  Â  Â  Â  Â  Â  <h3 class="section-title"><i class="fas fa-${icons[type]}"></i> ${title}</h3>
Â  Â  Â  Â  Â  Â  Â  <div class="section-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="editable" contenteditable="true">${sectionData.text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-attachments">${attachmentsHTML}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="add-attachment-btn"><i class="fas fa-paperclip"></i> Aggiungi</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  createAttachmentHTML(att, index) {
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  <div class="attachment-item" data-index="${index}">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="attachment-thumbnail">${att.type.includes('image') ? `<img src="${att.data}" alt="${att.name}">` : `<i class='fas fa-file-pdf'></i>`}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="attachment-name">${att.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-attachment-btn">&times;</button>
Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  parseDate(s){Â 
Â  Â  Â  Â  Â  if(!s) return null;Â 
Â  Â  Â  Â  Â  const p = s.split('/');Â 
Â  Â  Â  Â  Â  return p.length === 3 ? new Date(p[2], p[1] - 1, p[0]) : null;
Â  Â  Â  Â  }

Â  Â  Â  Â  formatDate(d){Â 
Â  Â  Â  Â  Â  return d ? `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}` : '';Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  autolinkUrls(element) {
Â  Â  Â  Â  Â  Â  // Semplice regex per trovare URL, evitando di linkare URL giÃ  in un tag <a>
Â  Â  Â  Â  Â  Â  const urlRegex = /(?<!href=")(https?:\/\/[^\s<]+[^\s<.,!?"')\];])/g;
Â  Â  Â  Â  Â  Â  let html = element.innerHTML;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (html.includes('<a href')) return;

Â  Â  Â  Â  Â  Â  html = html.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (html !== element.innerHTML) {
Â  Â  Â  Â  Â  Â  Â  Â  element.innerHTML = html;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  handleDayActions(e){
Â  Â  Â  Â  Â  const target = e.target;
Â  Â  Â  Â  Â  const button = target.closest('button');
Â  Â  Â  Â  Â  const item = target.closest('.attachment-item');
Â  Â  Â  Â  Â  const link = target.closest('a');

Â  Â  Â  Â  Â  if (link && link.href) {
Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  window.open(link.href, '_blank');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  Â  Â  const dayCard = button.closest('.day-card');
Â  Â  Â  Â  Â  Â  Â  if (!dayCard) return;
Â  Â  Â  Â  Â  Â  Â  const day = this.tripData.days.find(d => d.id === dayCard.dataset.id);
Â  Â  Â  Â  Â  Â  Â  if (!day) return;

Â  Â  Â  Â  Â  Â  Â  if (button.classList.contains('delete-day')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showConfirmModal('Eliminare Giorno?', `Sei sicuro di voler eliminare "${day.title}"?`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.tripData.days = this.tripData.days.filter(d => d.id !== day.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.handleDataChange();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.renderAllDays();
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  } else if (button.classList.contains('add-attachment-btn')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.currentAttachmentContext = { day, type: button.closest('.section').classList[1] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('attachmentFileInput').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.openModal('attachmentModal');
Â  Â  Â  Â  Â  Â  Â  } else if (button.classList.contains('delete-attachment-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const attachmentItem = button.closest('.attachment-item');
Â  Â  Â  Â  Â  Â  Â  Â  Â  const index = parseInt(attachmentItem.dataset.index);
Â  Â  Â  Â  Â  Â  Â  Â  Â  const section = day[attachmentItem.closest('.section').classList[1]];
Â  Â  Â  Â  Â  Â  Â  Â  Â  section.attachments.splice(index, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.handleDataChange();
Â  Â  Â  Â  Â  Â  Â  Â  Â  this.renderAllDays();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else if (item) {
Â  Â  Â  Â  Â  Â  Â  Â const dayCard = item.closest('.day-card');
Â  Â  Â  Â  Â  Â  Â  Â if(!dayCard) return;
Â  Â  Â  Â  Â  Â  Â  Â const day = this.tripData.days.find(d => d.id === dayCard.dataset.id);
Â  Â  Â  Â  Â  Â  Â  Â const index = parseInt(item.dataset.index);
Â  Â  Â  Â  Â  Â  Â  Â const sectionType = item.closest('.section').classList[1];
Â  Â  Â  Â  Â  Â  Â  Â const att = day[sectionType].attachments[index];
Â  Â  Â  Â  Â  Â  Â  Â if(att.type.includes('image')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â this.openViewAttachmentModal(att);
Â  Â  Â  Â  Â  Â  Â  Â } else if(att.type.includes('pdf')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const blob = this.dataURIToBlob(att.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â window.open(url, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  handleAttachmentConfirm(){Â 
Â  Â  Â  Â  Â  const fileInput = document.getElementById('attachmentFileInput');
Â  Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  Â  if(!file) return this.showNotification('Nessun file selezionato', 'error');

Â  Â  Â  Â  Â  const reader = new FileReader();Â 
Â  Â  Â  Â  Â  reader.onload = (e) => {Â 
Â  Â  Â  Â  Â  Â  const { day, type } = this.currentAttachmentContext;
Â  Â  Â  Â  Â  Â  if (!day[type].attachments) day[type].attachments = [];
Â  Â  Â  Â  Â  Â  day[type].attachments.push({Â 
Â  Â  Â  Â  Â  Â  Â  name: file.name,Â 
Â  Â  Â  Â  Â  Â  Â  type: file.type,Â 
Â  Â  Â  Â  Â  Â  Â  data: e.target.resultÂ 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  this.handleDataChange();Â 
Â  Â  Â  Â  Â  Â  this.renderAllDays();Â 
Â  Â  Â  Â  Â  Â  this.closeModal('attachmentModal');
Â  Â  Â  Â  Â  };Â 
Â  Â  Â  Â  Â  reader.readAsDataURL(file);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  dataURIToBlob(dataURI) {
Â  Â  Â  Â  Â  const byteString = atob(dataURI.split(',')[1]);
Â  Â  Â  Â  Â  const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
Â  Â  Â  Â  Â  const ab = new ArrayBuffer(byteString.length);
Â  Â  Â  Â  Â  const ia = new Uint8Array(ab);
Â  Â  Â  Â  Â  for (let i = 0; i < byteString.length; i++) {
Â  Â  Â  Â  Â  Â  Â  ia[i] = byteString.charCodeAt(i);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return new Blob([ab], { type: mimeString });
Â  Â  Â  Â  }

Â  Â  Â  Â  openViewAttachmentModal(att){Â 
Â  Â  Â  Â  Â  const fullscreenView = document.createElement('div');
Â  Â  Â  Â  Â  fullscreenView.className = 'fullscreen-attachment';
Â  Â  Â  Â  Â  fullscreenView.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <button class="close-fullscreen">&times;</button>
Â  Â  Â  Â  Â  Â  Â  <img src="${att.data}" alt="${att.name}">
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  const close = () => document.body.removeChild(fullscreenView);
Â  Â  Â  Â  Â  fullscreenView.querySelector('.close-fullscreen').addEventListener('click', close);
Â  Â  Â  Â  Â  fullscreenView.addEventListener('click', (e) => { if (e.target === fullscreenView) close(); });
Â  Â  Â  Â  Â  document.body.appendChild(fullscreenView);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  openModal(id) {
Â  Â  Â  Â  Â  Â  document.getElementById(id).style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  closeModal(id) {
Â  Â  Â  Â  Â  Â  document.getElementById(id).style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  showConfirmModal(title, text, callback) {
Â  Â  Â  Â  Â  document.getElementById('confirmModalTitle').textContent = title;
Â  Â  Â  Â  Â  document.getElementById('confirmModalText').textContent = text;
Â  Â  Â  Â  Â  this.onConfirmCallback = callback;
Â  Â  Â  Â  Â  this.openModal('confirmModal');
Â  Â  Â  Â  }

Â  Â  Â  Â  showNotification(msg, type = 'info', duration = 5000){Â 
Â  Â  Â  Â  Â  const notif = document.getElementById('notification');Â 
Â  Â  Â  Â  Â  notif.querySelector('#notificationText').textContent = msg;Â 
Â  Â  Â  Â  Â  notif.querySelector('i').className = `fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-circle'}`;
Â  Â  Â  Â  Â  notif.className = 'notification show';Â 
Â  Â  Â  Â  Â  setTimeout(() => notif.className = 'notification', duration);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  resetPlanner() {
Â  Â  Â  Â  Â  this.showConfirmModal('Reset Planner?', 'Tutti i dati verranno cancellati. Esporta un backup prima di continuare.', () => {
Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('oaxacaPlannerData');
Â  Â  Â  Â  Â  Â  Â  this.tripData = { days: [], background: 'https://images.unsplash.com/photo-1518638150340-f706e_86654de?ixlib=rb-1.2.1&auto=format&fit=crop&w=1500&q=80' };
Â  Â  Â  Â  Â  Â  Â  this.unsavedChanges = false;
Â  Â  Â  Â  Â  Â  Â  this.updateStorageStatus('success', 'Pronto per iniziare');
Â  Â  Â  Â  Â  Â  Â  this.updateUI();
Â  Â  Â  Â  Â  Â  Â  this.showIntro();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  handleImport(e) {
Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const importedData = JSON.parse(event.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (importedData && Array.isArray(importedData.days)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showConfirmModal('Importare Backup?', 'I dati attuali verranno sovrascritti.', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.tripData = importedData;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.saveToLocalStorage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateUI();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.unsavedChanges = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateStorageStatus('success', 'Backup importato');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Formato file non valido');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('File di backup non valido o corrotto.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.target.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  }

Â  Â  Â  Â  startAutoSaveSystem() {
Â  Â  Â  Â  Â  // Salva ogni 2 minuti se ci sono state modifiche
Â  Â  Â  Â  Â  this.autoSaveInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  if (this.unsavedChanges) {
Â  Â  Â  Â  Â  Â  Â  this.autoSaveToJSON();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, 120000);Â 
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  const planner = new AdvancedPlanner();
Â  Â  });
Â  </script>
</body>
</html>
